#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ù–ê –°–ï–†–í–ï–†–ï –ø–æ—Å–ª–µ git pull
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Ç–∞–º

set -e

echo "=========================================="
echo "üöÄ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ"
echo "=========================================="

cd /var/www/calorio

# 1. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ Git
echo ""
echo "1Ô∏è‚É£  –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ Git..."
git pull
echo "‚úÖ Git –æ–±–Ω–æ–≤–ª—ë–Ω"

# 2. –°–±–æ—Ä–∫–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
echo ""
echo "2Ô∏è‚É£  –°–±–æ—Ä–∫–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞..."
cd frontend
npm install --legacy-peer-deps
npm run build
cd ..
echo "‚úÖ –§—Ä–æ–Ω—Ç–µ–Ω–¥ —Å–æ–±—Ä–∞–Ω"

# 3. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
echo ""
echo "3Ô∏è‚É£  –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
source venv/bin/activate
pip install -q requests
echo "‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"

# 4. –°–±–æ—Ä–∫–∞ —Å—Ç–∞—Ç–∏–∫–∏ Django
echo ""
echo "4Ô∏è‚É£  –°–±–æ—Ä–∫–∞ —Å—Ç–∞—Ç–∏–∫–∏ Django..."
python manage.py collectstatic --noinput
deactivate
echo "‚úÖ –°—Ç–∞—Ç–∏–∫–∞ Django —Å–æ–±—Ä–∞–Ω–∞"

# 5. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤
echo ""
echo "5Ô∏è‚É£  –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤..."
sudo systemctl restart calorio
sudo systemctl reload nginx
echo "‚úÖ –°–µ—Ä–≤–∏—Å—ã –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω—ã"

# 6. –ü—Ä–æ–≤–µ—Ä–∫–∞
echo ""
echo "6Ô∏è‚É£  –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏..."
sleep 2
curl -s http://217.26.29.106/api/health/ && echo ""

echo ""
echo "=========================================="
echo "‚úÖ –í—Å–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã!"
echo "=========================================="
echo ""
echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ: http://217.26.29.106/"

