#!/usr/bin/expect -f
# Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ Ð´ÐµÐ¿Ð»Ð¾Ñ Ñ‡ÐµÑ€ÐµÐ· expect
# Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ: expect deploy_to_server.exp

set timeout 300
set server "217.26.29.106"
set user "root"
set password "C&6!wMqm!wOZ"

puts "=========================================="
puts "ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð´ÐµÐ¿Ð»Ð¾Ð¹ Calorio API"
puts "=========================================="
puts ""

# ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº ÑÐµÑ€Ð²ÐµÑ€Ñƒ
spawn ssh -o StrictHostKeyChecking=no $user@$server

expect {
    "password:" {
        send "$password\r"
    }
    timeout {
        puts "Timeout Ð¿Ñ€Ð¸ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ð¸"
        exit 1
    }
}

expect {
    "#" {
        puts "\nâœ… ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾\n"
    }
    timeout {
        puts "Timeout Ð¿Ñ€Ð¸ Ð¾Ð¶Ð¸Ð´Ð°Ð½Ð¸Ð¸ Ð¿Ñ€Ð¸Ð³Ð»Ð°ÑˆÐµÐ½Ð¸Ñ"
        exit 1
    }
}

# Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾Ð³Ð¾ ÐŸÐž
puts "ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾Ð³Ð¾ ÐŸÐž..."
send "apt update && apt install -y python3.11 python3.11-venv python3.11-dev git nginx postgresql postgresql-contrib build-essential libpq-dev curl\r"
expect "#"

# ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° PostgreSQL
puts "ðŸ—„ï¸ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° PostgreSQL..."
send "sudo -u postgres psql -c \"SELECT 1 FROM pg_database WHERE datname='calorio'\" | grep -q 1 || sudo -u postgres psql -c \"CREATE DATABASE calorio;\"\r"
expect "#"
send "sudo -u postgres psql -c \"SELECT 1 FROM pg_roles WHERE rolname='calorio_user'\" | grep -q 1 || sudo -u postgres psql -c \"CREATE USER calorio_user WITH PASSWORD 'calorio_secure_2024';\"\r"
expect "#"
send "sudo -u postgres psql -c \"GRANT ALL PRIVILEGES ON DATABASE calorio TO calorio_user;\"\r"
expect "#"

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
puts "ðŸ‘¤ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ calorio..."
send "id -u calorio &>/dev/null || useradd -m -s /bin/bash calorio\r"
expect "#"
send "mkdir -p /var/www/calorio && chown calorio:calorio /var/www/calorio\r"
expect "#"

# ÐšÐ»Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ/Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ
puts "ðŸ“¥ ÐšÐ»Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ..."
send "cd /var/www/calorio\r"
expect "#"
send "if \[ -d .git \]; then sudo -u calorio git pull origin main; else sudo -u calorio git clone https://github.com/moschin777-bot/calorio.git .; fi\r"
expect "#"

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
puts "ðŸ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ..."
send "sudo -u calorio bash -c 'cd /var/www/calorio && if \[ ! -d venv \]; then python3.11 -m venv venv; fi'\r"
expect "#"

# Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
puts "ðŸ“š Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹..."
send "sudo -u calorio bash -c 'cd /var/www/calorio && source venv/bin/activate && pip install --upgrade pip && pip install -r requirements.txt'\r"
expect "#"

# ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° .env
puts "âš™ï¸ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° .env Ñ„Ð°Ð¹Ð»Ð°..."
send "sudo -u calorio bash -c 'cd /var/www/calorio && if \[ ! -f .env \]; then cat > .env << ENVEOF\nSECRET_KEY=django-prod-key-$(openssl rand -hex 32)\nDEBUG=False\nALLOWED_HOSTS=217.26.29.106,colories.ru,www.colories.ru\nDATABASE_URL=postgresql://calorio_user:calorio_secure_2024@localhost:5432/calorio\nOPENROUTER_API_KEY=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\nPAYMENT_WEBHOOK_SECRET=webhook-$(openssl rand -hex 16)\nCORS_ALLOWED_ORIGINS=https://colories.ru,https://www.colories.ru,http://colories.ru,http://www.colories.ru\nENVEOF\nfi'\r"
expect "#"

# ÐŸÑ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¹
puts "ðŸ”„ ÐŸÑ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¹..."
send "sudo -u calorio bash -c 'cd /var/www/calorio && source venv/bin/activate && python manage.py migrate --noinput'\r"
expect "#"

# Ð¡Ð±Ð¾Ñ€ ÑÑ‚Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð²
puts "ðŸ“¦ Ð¡Ð±Ð¾Ñ€ ÑÑ‚Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð²..."
send "sudo -u calorio bash -c 'cd /var/www/calorio && source venv/bin/activate && python manage.py collectstatic --noinput'\r"
expect "#"

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ Ð´Ð»Ñ Ð»Ð¾Ð³Ð¾Ð²
send "sudo -u calorio mkdir -p /var/www/calorio/logs\r"
expect "#"

# ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° systemd service
puts "ðŸ”§ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° systemd service..."
send "cat > /etc/systemd/system/calorio.service << 'SERVICEEOF'\n\[Unit\]\nDescription=Calorio API Gunicorn daemon\nAfter=network.target\n\n\[Service\]\nType=notify\nUser=calorio\nGroup=calorio\nWorkingDirectory=/var/www/calorio\nEnvironment=\"PATH=/var/www/calorio/venv/bin\"\nExecStart=/var/www/calorio/venv/bin/gunicorn --workers 3 --bind unix:/var/www/calorio/gunicorn.sock --timeout 120 --access-logfile /var/www/calorio/logs/gunicorn-access.log --error-logfile /var/www/calorio/logs/gunicorn-error.log --log-level info calorio_api.wsgi:application\n\n\[Install\]\nWantedBy=multi-user.target\nSERVICEEOF\r"
expect "#"

send "systemctl daemon-reload\r"
expect "#"
send "systemctl enable calorio\r"
expect "#"
send "systemctl restart calorio\r"
expect "#"

# ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Nginx
puts "ðŸŒ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Nginx..."
send "cat > /etc/nginx/sites-available/calorio << 'NGINXEOF'\nupstream calorio_app \{\n    server unix:/var/www/calorio/gunicorn.sock fail_timeout=0;\n\}\n\nserver \{\n    listen 80;\n    server_name 217.26.29.106 colories.ru www.colories.ru;\n    client_max_body_size 10M;\n\n    location /static/ \{\n        alias /var/www/calorio/staticfiles/;\n    \}\n\n    location /media/ \{\n        alias /var/www/calorio/media/;\n    \}\n\n    location / \{\n        proxy_pass http://calorio_app;\n        proxy_set_header Host \$host;\n        proxy_set_header X-Real-IP \$remote_addr;\n        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto \$scheme;\n        proxy_redirect off;\n    \}\n\}\nNGINXEOF\r"
expect "#"

send "ln -sf /etc/nginx/sites-available/calorio /etc/nginx/sites-enabled/calorio\r"
expect "#"
send "rm -f /etc/nginx/sites-enabled/default\r"
expect "#"
send "nginx -t\r"
expect "#"
send "systemctl restart nginx\r"
expect "#"

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ð°Ñ‚ÑƒÑÐ°
puts "\nâœ… ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ð°Ñ‚ÑƒÑÐ° ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²...\n"
send "systemctl status calorio --no-pager | head -n 10\r"
expect "#"
send "systemctl status nginx --no-pager | head -n 10\r"
expect "#"

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° API
puts "\nðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° API...\n"
send "sleep 3 && curl -s http://localhost/api/health/ || echo 'API Ð½Ðµ Ð¾Ñ‚Ð²ÐµÑ‡Ð°ÐµÑ‚'\r"
expect "#"

puts "\n=========================================="
puts "âœ… Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð·Ð°Ð²ÐµÑ€ÑˆÑ‘Ð½!"
puts "=========================================="
puts ""
puts "ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ñƒ API:"
puts "  curl http://217.26.29.106/api/health/"
puts "  curl http://colories.ru/api/health/"
puts ""

send "exit\r"
expect eof

